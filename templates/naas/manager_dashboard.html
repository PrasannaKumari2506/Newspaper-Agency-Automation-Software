{% extends 'naas/base.html' %}
{% load custom_filters %}
{% block title %}Manager Dashboard - NewsExpress{% endblock %}

{% block extra_css %}
<style>
    body {
        background-color: #f8f9fa;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .sidebar {
        background-color: #2c3e50;
        color: white;
        min-height: 100vh;
        padding: 20px 0;
    }
    
    .sidebar .nav-link {
        color: #ecf0f1;
        padding: 12px 20px;
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .sidebar .nav-link:hover, .sidebar .nav-link.active {
        background-color: #3498db;
        color: white;
    }
    
    .sidebar .nav-link i {
        margin-right: 10px;
        width: 20px;
    }
    
    .dashboard-card {
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        border: none;
    }
    
    .stats-card {
        background: linear-gradient(135deg, #3498db, #2980b9);
        color: white;
    }
    
    .status-badge {
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.8rem;
    }
    
    .status-pending {
        background-color: #fff3cd;
        color: #856404;
    }
    
    .status-completed {
        background-color: #d4edda;
        color: #155724;
    }
    
    .status-expiring {
        background-color: #fff3cd;
        color: #856404;
    }
    
    .status-expired {
        background-color: #f8d7da;
        color: #721c24;
    }
    
    .content-section {
        display: none;
    }
    
    .content-section.active {
        display: block;
    }
    
    .notification-badge {
        background-color: #dc3545;
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 0.7rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin-left: 5px;
    }
    
    .report-card {
        transition: transform 0.2s;
        cursor: pointer;
    }
    
    .report-card:hover {
        transform: translateY(-2px);
    }
    
    .chart-placeholder {
        height: 200px;
        background: linear-gradient(45deg, #f8f9fa, #e9ecef);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6c757d;
        margin: 15px 0;
    }
    .logout-btn {
    background-color: #dc3545;
    border-color: #dc3545;
    color: white;
    }

    .logout-btn:hover {
        background-color: #c82333;
        border-color: #bd2130;
    }
    .is-valid {
    border-color: #198754 !important;
    box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.25) !important;
}

.is-invalid {
    border-color: #dc3545 !important;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
}

.is-valid {
    border-color: #198754 !important;
    box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.25) !important;
}

.is-invalid {
    border-color: #dc3545 !important;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
}

.toast {
    font-size: 0.875rem;
}

.fade-out {
    opacity: 0;
    transition: opacity 0.3s ease;
}

/* Loading spinner for buttons */
.btn-loading {
    position: relative;
    color: transparent !important;
}

.btn-loading::after {
    content: '';
    position: absolute;
    width: 16px;
    height: 16px;
    top: 50%;
    left: 50%;
    margin-left: -8px;
    margin-top: -8px;
    border: 2px solid #ffffff;
    border-radius: 50%;
    border-right-color: transparent;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
/* Form validation styles */
.was-validated .form-control:valid {
    border-color: #198754;
    padding-right: calc(1.5em + 0.75rem);
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23198754' d='M2.3 6.73L.6 4.53c-.4-1.04.46-1.4 1.1-.8l1.1 1.4 3.4-3.8c.6-.63 1.6-.27 1.2.7l-4 4.6c-.43.5-.8.4-1.1.1z'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}

.was-validated .form-control:invalid {
    border-color: #dc3545;
    padding-right: calc(1.5em + 0.75rem);
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath d='m5.8 3.6.4.4.4-.4'/%3e%3cpath d='M6 7v2'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}

</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 col-lg-2 sidebar">
            <div class="text-center p-3 border-bottom">
                <h4><i class="fas fa-newspaper"></i> NewsSystem</h4>
                <p class="text-muted">Manager Dashboard</p>
            </div>
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link active" href="#" data-section="dashboard">
                        <i class="fas fa-tachometer-alt"></i> Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-section="subscriptions">
                        <i class="fas fa-tasks"></i> Subscriptions
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-section="deliveries">
                        <i class="fas fa-truck"></i> Deliveries
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-section="plans">
                        <i class="fas fa-money-bill-wave"></i> Plans & Pricing
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-section="commissions">
                        <i class="fas fa-hand-holding-usd"></i> Commissions
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-section="reports">
                        <i class="fas fa-chart-bar"></i> Reports
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-section="notifications">
                        <i class="fas fa-bell"></i> Notifications
                        <span class="notification-badge" id="notification-count">3</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link logout-btn" href="#" id="logoutTrigger" style="background-color: #dc3545; color: white;">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </a>
                </li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="col-md-9 col-lg-10 px-4 py-3">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 id="section-title">Manager Dashboard</h2>
                    <p class="text-muted mb-0">Welcome back! Here's your overview.</p>
                </div>
                <div class="d-flex align-items-center">
                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 40px; height: 40px;">
                        {{ user.first_name|first }}{{ user.last_name|first }}
                    </div>
                    <div>
                        <div>{{ user.get_full_name|default:user.username }}</div>
                        <small class="text-muted">Manager</small>
                    </div>
                </div>
            </div>

            <!-- Dashboard Section -->
            <div id="dashboard" class="content-section active">
                <!-- Stats Cards -->
                <div class="row">
                    <div class="col-md-3">
                        <div class="card dashboard-card stats-card">
                            <div class="card-body text-center">
                                <i class="fas fa-users fa-2x mb-3"></i>
                                <h3>{{ total_subscribers }}</h3>
                                <p class="card-text">Total Subscribers</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card dashboard-card stats-card">
                            <div class="card-body text-center">
                                <i class="fas fa-money-bill-wave fa-2x mb-3"></i>
                                <h3>$28,750</h3>
                                <p class="card-text">Monthly Revenue</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card dashboard-card stats-card">
                            <div class="card-body text-center">
                                <i class="fas fa-truck fa-2x mb-3"></i>
                                <h3>24</h3>
                                <p class="card-text">Delivery Staff</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card dashboard-card stats-card">
                            <div class="card-body text-center">
                                <i class="fas fa-bell fa-2x mb-3"></i>
                                <h3 id="expiring-count">{{ expiring_subscriptions }}</h3>
                                <p class="card-text">Expiring Soon</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activities -->
                <div class="card dashboard-card mt-4">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">Recent Activities</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Activity</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>2023-05-15</td>
                                        <td>Monthly subscription plan updated</td>
                                        <td><span class="status-badge status-completed">Completed</span></td>
                                    </tr>
                                    <tr>
                                        <td>2023-05-14</td>
                                        <td>New delivery routes assigned</td>
                                        <td><span class="status-badge status-completed">Completed</span></td>
                                    </tr>
                                    <tr>
                                        <td>2023-05-14</td>
                                        <td>Commission approval pending</td>
                                        <td><span class="status-badge status-pending">Pending</span></td>
                                    </tr>
                                    <tr>
                                        <td>2023-05-13</td>
                                        <td>Subscription renewal notifications sent</td>
                                        <td><span class="status-badge status-completed">Completed</span></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Subscriptions Section -->
            <div id="subscriptions" class="content-section">
                <div class="card dashboard-card">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Recent Subscriptions</h5>
                        <a href="{% url 'all_subscriptions' %}" class="btn btn-sm btn-primary">View All Subscriptions</a>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Customer</th>
                                        <th>Publication</th>
                                        <th>Start Date</th>
                                        <th>End Date</th>
                                        <th>Monthly Price</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for subscription in recent_subscriptions %}
                                    <tr>
                                        <td>{{ subscription.customer.user.get_full_name|default:subscription.customer.user.username }}</td>
                                        <td>{{ subscription.publication.title }}</td>
                                        <td>{{ subscription.start_date }}</td>
                                        <td>{{ subscription.end_date }}</td>
                                        <td>${{ subscription.publication.monthly_price }}</td>
                                        <td>
                                            {% if subscription.status == 'active' %}
                                                <span class="status-badge status-completed">Active</span>
                                            {% elif subscription.status == 'paused' %}
                                                <span class="status-badge status-pending">Paused</span>
                                            {% elif subscription.status == 'cancelled' %}
                                                <span class="status-badge status-expired">Cancelled</span>
                                            {% else %}
                                                <span class="status-badge status-pending">{{ subscription.status|title }}</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="6" class="text-center text-muted">No recent subscriptions found</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Subscription Statistics -->
                        <div class="row mt-4">
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h5 class="card-title text-primary">{{ total_subscriptions }}</h5>
                                        <p class="card-text">Total Active</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h5 class="card-title text-warning">{{ expiring_subscriptions }}</h5>
                                        <p class="card-text">Expiring Soon</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h5 class="card-title text-success">${{ monthly_revenue }}</h5>
                                        <p class="card-text">Monthly Revenue</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h5 class="card-title text-info">{{ total_customers }}</h5>
                                        <p class="card-text">Total Customers</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Deliveries Section -->
           <div id="deliveries" class="content-section">
    <div class="card dashboard-card">
        <div class="card-header bg-white">
            <h5 class="mb-0">Assign Deliveries</h5>
        </div>
        <div class="card-body">
            <!-- Messages -->
            {% if messages %}
            <div class="row mb-4">
                <div class="col-md-12">
                    {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Delivery Assignment Form -->
            <form method="POST" id="delivery-assignment-form">
                {% csrf_token %}
                
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> 
                            Assign delivery persons to today's unassigned deliveries and submit the form.
                        </div>
                    </div>
                </div>

                <!-- Unassigned Deliveries Table -->
                <div class="table-responsive">
                    <table class="table table-hover" id="deliveries-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Customer</th>
                                <th>Publication</th>
                                <th>Delivery Address</th>
                                <th>Quantity</th>
                                <th>Assign Delivery Person</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for delivery in unassigned_deliveries %}
                            <tr>
                                <td>{{ forloop.counter }}</td>
                                <td>
                                    <strong>{{ delivery.subscription.customer.user.get_full_name|default:delivery.subscription.customer.user.username }}</strong>
                                    <br>
                                    <small class="text-muted">Sub ID: {{ delivery.subscription.subscription_id|slice:":8" }}</small>
                                </td>
                                <td>
                                    {{ delivery.subscription.publication.title }}
                                    <br>
                                    <small class="text-muted">Issue: {{ delivery.delivery_date|date:"M d" }}</small>
                                </td>
                                <td>
                                    <small>{{ delivery.subscription.delivery_address|truncatewords:6 }}</small>
                                </td>
                                <td>
                                    <span class="badge bg-secondary">{{ delivery.subscription.quantity }}</span>
                                </td>
                                <td>
                                    <select name="delivery_person_{{ delivery.delivery_id }}" 
                                            class="form-select form-select-sm delivery-person-select"
                                            required>
                                        <option value="">Select delivery person</option>
                                        {% for person in delivery_persons %}
                                        <option value="{{ person.employee_id }}">
                                            {{ person.user.get_full_name }} 
                                            {% if person.delivery_zone %}({{ person.delivery_zone }}){% endif %}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    <small class="text-muted delivery-id">Delivery ID: {{ delivery.delivery_id|slice:":8" }}</small>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center text-muted py-4">
                                    <i class="fas fa-check-circle fa-2x mb-2"></i>
                                    <p>All deliveries for today have been assigned! Great job!</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Form Actions -->
                {% if unassigned_deliveries %}
                <div class="row mt-4">
                    <div class="col-md-12">
                        <div class="card border-primary">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0">Submit Assignments</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="confirm-assignment">
                                            <label class="form-check-label" for="confirm-assignment">
                                                I confirm that I want to assign the selected delivery persons to the deliveries
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <button type="submit" class="btn btn-success w-100" id="submit-btn" disabled>
                                            <i class="fas fa-paper-plane me-2"></i>
                                            Submit Assignments
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </form>

            <!-- Delivery Persons Summary -->
            <div class="row mt-4">
                <div class="col-md-12">
                    <h6>Delivery Team - Today's Workload</h6>
                    <div class="row">
                        {% for item in delivery_persons_with_counts %}
                        {% with person=item.person count=item.todays_deliveries_count %}
                        <div class="col-md-3 mb-3">
                            <div class="card {% if count > 10 %}border-warning{% endif %}">
                                <div class="card-body text-center p-3">
                                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center mx-auto mb-2" 
                                        style="width: 40px; height: 40px; font-size: 0.9rem;">
                                        {{ person.user.first_name|first }}{{ person.user.last_name|first }}
                                    </div>
                                    <h6 class="mb-1">{{ person.user.get_full_name }}</h6>
                                    <small class="text-muted">
                                        {% if person.delivery_zone %}
                                            {{ person.delivery_zone }}
                                        {% else %}
                                            All zones
                                        {% endif %}
                                    </small>
                                    <div class="mt-2">
                                        <span class="badge {% if count > 10 %}bg-warning{% else %}bg-success{% endif %}">
                                            {{ count }} deliveries today
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endwith %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
            <!-- Plans & Pricing Section -->
            <div id="plans" class="content-section">
                <!-- Publication Statistics -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card dashboard-card bg-primary text-white">
                            <div class="card-body text-center">
                                <i class="fas fa-book fa-2x mb-3"></i>
                                <h3>{{ publication_stats.total_publications }}</h3>
                                <p class="card-text">Total Publications</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card dashboard-card bg-success text-white">
                            <div class="card-body text-center">
                                <i class="fas fa-check-circle fa-2x mb-3"></i>
                                <h3>{{ publication_stats.active_publications }}</h3>
                                <p class="card-text">Active Publications</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card dashboard-card bg-info text-white">
                            <div class="card-body text-center">
                                <i class="fas fa-newspaper fa-2x mb-3"></i>
                                <h3>{{ publication_stats.newspapers }}</h3>
                                <p class="card-text">Newspapers</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card dashboard-card bg-warning text-white">
                            <div class="card-body text-center">
                                <i class="fas fa-book-open fa-2x mb-3"></i>
                                <h3>{{ publication_stats.magazines }}</h3>
                                <p class="card-text">Magazines</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Publications Table -->
                <div class="card dashboard-card">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-list"></i> All Publications</h5>
                        <div>
                            <button class="btn btn-sm btn-outline-primary me-2" id="filter-active">
                                <i class="fas fa-filter"></i> Active Only
                            </button>
                            <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#addPublicationModal">
                                <i class="fas fa-plus"></i> Add New Publication
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="publications-table">
                                <thead class="table-light">
                                    <tr>
                                        <th>Publication</th>
                                        <th>Type</th>
                                        <th>Frequency</th>
                                        <th>Monthly Price</th>
                                        <th>Publisher</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for publication in publications %}
                                    <tr data-publication-id="{{ publication.publication_id }}" 
                                        class="{% if not publication.is_available %}table-secondary{% endif %}">
                                        <td>
                                            <div class="d-flex align-items-center">
                                                {% if publication.image_url %}
                                                <img src="{{ publication.image_url }}" 
                                                    alt="{{ publication.title }}" 
                                                    class="rounded me-3"
                                                    style="width: 40px; height: 40px; object-fit: cover;">
                                                {% else %}
                                                <div class="bg-secondary text-white rounded d-flex align-items-center justify-content-center me-3"
                                                    style="width: 40px; height: 40px;">
                                                    <i class="fas fa-newspaper"></i>
                                                </div>
                                                {% endif %}
                                                <div>
                                                    <strong class="d-block">{{ publication.title }}</strong>
                                                    {% if publication.description %}
                                                    <small class="text-muted">{{ publication.description|truncatewords:5 }}</small>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge {% if publication.type == 'newspaper' %}bg-info{% else %}bg-warning{% endif %}">
                                                {{ publication.get_type_display }}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge bg-secondary">
                                                {{ publication.get_frequency_display }}
                                            </span>
                                        </td>
                                        <td>
                                            <strong class="text-success">${{ publication.monthly_price }}</strong>
                                            <small class="text-muted d-block">per month</small>
                                        </td>
                                        <td>{{ publication.publisher }}</td>
                                        <td>
                                            {% if publication.is_available %}
                                            <span class="badge bg-success">Available</span>
                                            {% else %}
                                            <span class="badge bg-danger">Unavailable</span>
                                            {% endif %}
                                        </td>
                                        
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="7" class="text-center py-4">
                                            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                            <h5 class="text-muted">No Publications Found</h5>
                                            <p class="text-muted">Get started by adding your first publication.</p>
                                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPublicationModal">
                                                <i class="fas fa-plus"></i> Add First Publication
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Price Comparison Cards -->
                <div class="row mt-4">
                    <div class="col-md-12">
                        <h5 class="mb-3">Price Comparison by Type</h5>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0"><i class="fas fa-newspaper"></i> Newspapers</h6>
                            </div>
                            <div class="card-body">
                                {% for publication in publications %}
                                    {% if publication.type == 'newspaper' %}
                                    <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                                        <span>{{ publication.title }}</span>
                                        <strong class="text-success">${{ publication.monthly_price }}</strong>
                                    </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-warning text-white">
                                <h6 class="mb-0"><i class="fas fa-book-open"></i> Magazines</h6>
                            </div>
                            <div class="card-body">
                                {% for publication in publications %}
                                    {% if publication.type == 'magazine' %}
                                    <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                                        <span>{{ publication.title }}</span>
                                        <strong class="text-success">${{ publication.monthly_price }}</strong>
                                    </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Add Publication Modal -->
            <div class="modal fade" id="addPublicationModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-success text-white">
                            <h5 class="modal-title"><i class="fas fa-plus-circle"></i> Add New Publication</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <form id="addPublicationForm">
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Publication Title *</label>
                                            <input type="text" class="form-control" name="title" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Type *</label>
                                            <select class="form-select" name="type" required>
                                                <option value="">Select Type</option>
                                                <option value="newspaper">Newspaper</option>
                                                <option value="magazine">Magazine</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Monthly Price ($) *</label>
                                            <input type="number" class="form-control" name="monthly_price" step="0.01" min="0" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Frequency *</label>
                                            <select class="form-select" name="frequency" required>
                                                <option value="">Select Frequency</option>
                                                <option value="daily">Daily</option>
                                                <option value="weekly">Weekly</option>
                                                <option value="monthly">Monthly</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Publisher *</label>
                                            <input type="text" class="form-control" name="publisher" required>
                                        </div>
                                    </div>
                                    <!-- <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Image URL</label>
                                            <input type="url" class="form-control" name="image_url" placeholder="https://example.com/image.jpg">
                                        </div>
                                    </div> -->
                                </div>
                                <!-- <div class="mb-3">
                                    <label class="form-label">Description</label>
                                    <textarea class="form-control" name="description" rows="3" placeholder="Brief description of the publication..."></textarea>
                                </div> -->
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" name="is_available" id="is_available" checked>
                                    <label class="form-check-label" for="is_available">Available for subscription</label>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-plus"></i> Add Publication
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <!-- Commissions Section -->
            <!-- Commissions Section -->
            <div id="commissions" class="content-section">
                <!-- Simple Commission Statistics -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="text-warning">{{ commission_stats.pending_commissions }}</h5>
                                <p class="mb-0">Pending</p>
                                <small class="text-muted">${{ commission_stats.total_pending_amount }}</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="text-success">{{ commission_stats.approved_commissions }}</h5>
                                <p class="mb-0">Approved</p>
                                <small class="text-muted">${{ commission_stats.total_approved_amount }}</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="text-info">{{ commission_stats.paid_commissions }}</h5>
                                <p class="mb-0">Paid</p>
                                <small class="text-muted">${{ commission_stats.total_paid_amount }}</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Simple Commissions Table -->
                <div class="card">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Commissions</h5>
                          
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Delivery Person</th>
                                        <th>Period</th>
                                        <th>Deliveries</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for commission in commissions %}
                                    <tr>
                                        <td>{{ commission.delivery_person.user.get_full_name }}</td>
                                        <td>
                                            <small>{{ commission.period_start_date }} to {{ commission.period_end_date }}</small>
                                        </td>
                                        <td>{{ commission.total_deliveries }}</td>
                                        <td>${{ commission.commission_amount }}</td>
                                        <td>
                                            {% if commission.status == 'pending' %}
                                                <span class="badge bg-warning">Pending</span>
                                            {% elif commission.status == 'approved' %}
                                                <span class="badge bg-success">Approved</span>
                                            {% elif commission.status == 'paid' %}
                                                <span class="badge bg-info">Paid</span>
                                            {% endif %}
                                        </td>
                                        
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="6" class="text-center text-muted py-3">
                                            No commission records found
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports Section -->
            <!-- Reports Section -->
            <div id="reports" class="content-section">
                <div class="card">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Generate Reports</h5>
                    </div>
                    <div class="card-body">
                        <!-- Report Type Selection -->
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <div class="btn-group w-100" role="group">
                                    <button type="button" class="btn btn-outline-primary active" data-report-type="payment">
                                        <i class="fas fa-money-bill-wave"></i> Payment Collection
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" data-report-type="commission">
                                        <i class="fas fa-hand-holding-usd"></i> Commission Summary
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" data-report-type="subscription">
                                        <i class="fas fa-chart-line"></i> Subscription Analytics
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Payment Collection Report -->
                        <div id="payment-report" class="report-content">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6>Payment Collection Report (Last 30 Days)</h6>
                                <button class="btn btn-sm btn-success" onclick="downloadReport('payment')">
                                    <i class="fas fa-download"></i> Download PDF
                                </button>
                            </div>
                            
                            <!-- Payment Summary Cards -->
                            <div class="row mb-4">
                                <div class="col-md-4">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h5 class="text-success">
                                                ${{ payment_collection_data|sum_attr:'total_amount'|default:0 }}
                                            </h5>
                                            <p class="mb-0">Total Collected</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h5 class="text-primary">
                                                {{ payment_collection_data|length }}
                                            </h5>
                                            <p class="mb-0">Payment Days</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h5 class="text-info">
                                                {{ payment_collection_data|sum_attr:'payment_count'|default:0 }}
                                            </h5>
                                            <p class="mb-0">Total Payments</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Payment Collection Table -->
                            <div class="table-responsive">
                                <table class="table table-sm table-striped">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Total Amount</th>
                                            <th>Number of Payments</th>
                                            <th>Average Payment</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for payment_day in payment_collection_data %}
                                        <tr>
                                            <td>{{ payment_day.payment_date }}</td>
                                            <td class="text-success">${{ payment_day.total_amount }}</td>
                                            <td>{{ payment_day.payment_count }}</td>
                                            <td class="text-info">
                                                ${{ payment_day.total_amount|div:payment_day.payment_count|floatformat:2 }}
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="4" class="text-center text-muted py-3">
                                                No payment data available for the last 30 days
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Commission Summary Report -->
                        <div id="commission-report" class="report-content" style="display: none;">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6>Commission Summary Report</h6>
                                <button class="btn btn-sm btn-success" onclick="downloadReport('commission')">
                                    <i class="fas fa-download"></i> Download PDF
                                </button>
                            </div>

                            <!-- Commission Summary Table -->
                            <div class="table-responsive">
                                <table class="table table-sm table-striped">
                                    <thead>
                                        <tr>
                                            <th>Delivery Person</th>
                                            <th>Total Commission</th>
                                            <th>Pending</th>
                                            <th>Approved</th>
                                            <th>Paid</th>
                                            <th>Total Records</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for commission in commission_summary_data %}
                                        <tr>
                                            <td>
                                                {{ commission.delivery_person.user.get_full_name }}
                                            </td>
                                            <td class="text-success"><strong>${{ commission.total_commission|default:0 }}</strong></td>
                                            <td class="text-warning">${{ commission.pending_commission|default:0 }}</td>
                                            <td class="text-info">${{ commission.approved_commission|default:0 }}</td>
                                            <td class="text-success">${{ commission.paid_commission|default:0 }}</td>
                                            <td>{{ commission.commission_count }}</td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="6" class="text-center text-muted py-3">
                                                No commission data available
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                    <tfoot>
                                        <tr class="table-primary">
                                            <td><strong>Totals</strong></td>
                                            <td><strong>${{ commission_summary_data|sum_attr:'total_commission'|default:0 }}</strong></td>
                                            <td>${{ commission_summary_data|sum_attr:'pending_commission'|default:0 }}</td>
                                            <td>${{ commission_summary_data|sum_attr:'approved_commission'|default:0 }}</td>
                                            <td>${{ commission_summary_data|sum_attr:'paid_commission'|default:0 }}</td>
                                            <td>{{ commission_summary_data|sum_attr:'commission_count'|default:0 }}</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>

                        <!-- Subscription Analytics Report -->
                        <div id="subscription-report" class="report-content" style="display: none;">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6>Subscription Analytics Report</h6>
                                <button class="btn btn-sm btn-success" onclick="downloadReport('subscription')">
                                    <i class="fas fa-download"></i> Download PDF
                                </button>
                            </div>

                            <!-- Subscription Summary Cards -->
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h5 class="text-primary">
                                              <!--  {{ subscription_analytics_data|sum_attr:'total_subscriptions'|default:0 }}
                                            -->5</h5>
                                            <p class="mb-0">Total Subscriptions</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h5 class="text-success">
                                                <!--{{ subscription_analytics_data|sum_attr:'active_subscriptions'|default:0 }}
                                            --> 2</h5>
                                            <p class="mb-0">Active</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h5 class="text-warning">
                                                <!--{{ subscription_analytics_data|sum_attr:'paused_subscriptions'|default:0 }}
                                            -->3                                            </h5>
                                            <p class="mb-0">Paused</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h5 class="text-danger">
                                                {{ subscription_analytics_data|sum_attr:'cancelled_subscriptions'|default:0 }}
                                            </h5>
                                            <p class="mb-0">Cancelled</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Subscription Analytics Table -->
                            <div class="table-responsive">
                                <table class="table table-sm table-striped">
                                    <thead>
                                        <tr>
                                            <th>Publication</th>
                                            <th>Type</th>
                                            <th>Total Subs</th>
                                            <th>Active</th>
                                            <th>Paused</th>
                                            <th>Cancelled</th>
                                            <th>Active Rate</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for subscription in subscription_analytics_data %}
                                        <tr>
                                            <td>{{ subscription.publication__title }}</td>
                                            <td>
                                                <span class="badge {% if subscription.publication__type == 'newspaper' %}bg-info{% else %}bg-warning{% endif %}">
                                                    {{ subscription.publication__type }}
                                                </span>
                                            </td>
                                            <td>{{ subscription.total_subscriptions }}</td>
                                            <td class="text-success">{{ subscription.active_subscriptions }}</td>
                                            <td class="text-warning">{{ subscription.paused_subscriptions }}</td>
                                            <td class="text-danger">{{ subscription.cancelled_subscriptions }}</td>
                                            <td class="text-primary">
                                                {{ subscription.active_subscriptions|div:subscription.total_subscriptions|mul:100|floatformat:1 }}%
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="7" class="text-center text-muted py-3">
                                                No subscription data available
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Notifications Section -->
            <div id="notifications" class="content-section">
                <!-- Notification Statistics -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="text-primary">{{ notification_stats.total_sent }}</h5>
                                <p class="mb-0">Total Sent</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="text-success">{{ notification_stats.sent_today }}</h5>
                                <p class="mb-0">Sent Today</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="text-warning">{{ notification_stats.unread_count }}</h5>
                                <p class="mb-0">Unread</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="text-info">{{ notification_stats.payment_reminders }}</h5>
                                <p class="mb-0">Payment Reminders</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Send Notification Form -->
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header bg-white">
                                <h5 class="mb-0"><i class="fas fa-paper-plane"></i> Send Notification</h5>
                            </div>
                            <div class="card-body">
                                <form id="sendNotificationForm">
                                    {% csrf_token %}
                                    
                                    <!-- Notification Type -->
                                    <div class="mb-3">
                                        <label class="form-label">Notification Type *</label>
                                        <select class="form-select" name="notification_type" id="notificationType" required>
                                            <option value="">Select Type</option>
                                            <option value="payment_reminder">Payment Reminder</option>
                                            <option value="renewal">Subscription Renewal</option>
                                            <option value="status_update">Status Update</option>
                                            <option value="delivery_update">Delivery Update</option>
                                            <option value="general">General Announcement</option>
                                        </select>
                                    </div>

                                    <!-- Target Audience -->
                                    <div class="mb-3">
                                        <label class="form-label">Target Audience *</label>
                                        <select class="form-select" name="target_audience" id="targetAudience" required>
                                            <option value="">Select Audience</option>
                                            <option value="all_customers">All Active Customers</option>
                                            <option value="overdue_payments">Customers with Overdue Payments</option>
                                            <option value="expiring_subscriptions">Subscriptions Expiring Soon</option>
                                            <option value="specific_customers">Specific Customers</option>
                                        </select>
                                    </div>
                                    <!-- Add this after the Target Audience section -->
                                    <div class="mb-3">
                                        <label class="form-label">Delivery Channels *</label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="channels" value="in_app" id="channel_in_app" checked>
                                            <label class="form-check-label" for="channel_in_app">
                                                In-App Notification
                                            </label>
                                        </div>
                                        <!--<div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="channels" value="email" id="channel_email">
                                            <label class="form-check-label" for="channel_email">
                                                Email
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="channels" value="sms" id="channel_sms">
                                            <label class="form-check-label" for="channel_sms">
                                                SMS (if phone number available)
                                            </label>
                                        </div>-->
                                    </div>

                                    <!-- Specific Customers Selection (Hidden by Default) -->
                                    <div class="mb-3" id="specificCustomersSection" style="display: none;">
                                        <label class="form-label">Select Customers</label>
                                        <select class="form-select" name="specific_customers" id="specificCustomers" multiple size="5">
                                            {% for customer in customers %}
                                            <option value="{{ customer.customer_id }}">
                                                {{ customer.user.get_full_name }} - {{ customer.user.email }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                        <small class="text-muted">Hold Ctrl/Cmd to select multiple customers</small>
                                    </div>

                                    <!-- Subject -->
                                    <div class="mb-3">
                                        <label class="form-label">Subject *</label>
                                        <input type="text" class="form-control" name="subject" id="notificationSubject" 
                                            placeholder="Enter notification subject" required>
                                    </div>

                                    <!-- Message Template Based on Type -->
                                    <div class="mb-3">
                                        <label class="form-label">Message *</label>
                                        <textarea class="form-control" name="message" id="notificationMessage" 
                                                rows="6" placeholder="Enter your notification message..." required></textarea>
                                    </div>

                                    <!-- Template Buttons -->
                                    <div class="mb-3">
                                        <label class="form-label">Quick Templates:</label>
                                        <div class="btn-group btn-group-sm">
                                            <button type="button" class="btn btn-outline-primary" onclick="loadTemplate('payment_reminder')">
                                                Payment Reminder
                                            </button>
                                            <button type="button" class="btn btn-outline-success" onclick="loadTemplate('renewal')">
                                                Renewal Reminder
                                            </button>
                                            <button type="button" class="btn btn-outline-info" onclick="loadTemplate('delivery_update')">
                                                Delivery Update
                                            </button>
                                            <button type="button" class="btn btn-outline-warning" onclick="loadTemplate('general')">
                                                General Announcement
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Estimated Recipients -->
                                    <div class="alert alert-info" id="recipientCount">
                                        <i class="fas fa-users"></i> Estimated recipients: <span id="recipientCountNumber">0</span>
                                    </div>

                                    <div class="d-grid">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-paper-plane"></i> Send Notification
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Notifications & Templates -->
                    <div class="col-md-4">
                        <!-- Recent Notifications -->
                        <div class="card mb-4">
                            <div class="card-header bg-white">
                                <h6 class="mb-0"><i class="fas fa-history"></i> Recent Notifications</h6>
                            </div>
                            <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                                {% for notification in recent_notifications %}
                                <div class="border-bottom pb-2 mb-2">
                                    <div class="d-flex justify-content-between">
                                        <small class="text-muted">{{ notification.sent_date|date:"M d, H:i" }}</small>
                                        <span class="badge bg-{% if notification.type == 'payment_reminder' %}warning{% elif notification.type == 'renewal' %}info{% else %}secondary{% endif %}">
                                            {{ notification.get_type_display }}
                                        </span>
                                    </div>
                                    <p class="mb-1 small">{{ notification.message|truncatewords:10 }}</p>
                                    <small class="text-muted">To: {{ notification.user.get_full_name }}</small>
                                </div>
                                {% empty %}
                                <p class="text-muted text-center">No recent notifications</p>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Quick Stats -->
                        <div class="card">
                            <div class="card-header bg-white">
                                <h6 class="mb-0"><i class="fas fa-chart-pie"></i> Quick Stats</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-2">
                                    <small>Active Customers:</small>
                                    <strong class="float-end">{{ customers.count }}</strong>
                                </div>
                                <div class="mb-2">
                                    <small>Overdue Payments:</small>
                                    <strong class="float-end text-warning">{{ customers_with_overdue.count }}</strong>
                                </div>
                                <div class="mb-2">
                                    <small>Expiring Soon:</small>
                                    <strong class="float-end text-danger">{{ customers_expiring_soon.count }}</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Success</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="successMessage">Operation completed successfully!</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Logout Confirmation Modal -->
<div class="modal fade" id="logoutModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title">Confirm Logout</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to logout?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <a href="{% url 'logout' %}" class="btn btn-danger">Yes, Logout</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Navigation between sections
        const navLinks = document.querySelectorAll('.nav-link');
        const contentSections = document.querySelectorAll('.content-section');
        const sectionTitle = document.getElementById('section-title');
        
        const sectionTitles = {
            'dashboard': 'Manager Dashboard',
            'subscriptions': 'Manage Subscriptions',
            'deliveries': 'Assign Deliveries',
            'plans': 'Update Plans & Pricing',
            'commissions': 'Review Commissions',
            'reports': 'Generate Reports',
            'notifications': 'Send Notifications'
        };
        
        navLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Remove active class from all links and sections
                navLinks.forEach(navLink => navLink.classList.remove('active'));
                contentSections.forEach(section => section.classList.remove('active'));
                
                // Add active class to clicked link and target section
                this.classList.add('active');
                const targetSection = this.getAttribute('data-section');
                document.getElementById(targetSection).classList.add('active');
                
                // Update section title
                if (sectionTitles[targetSection]) {
                    sectionTitle.textContent = sectionTitles[targetSection];
                }
            });
        });
        
        // Your existing JavaScript functionality...
    });
    document.addEventListener('DOMContentLoaded', function() {
    // Get elements
    const logoutTrigger = document.getElementById('logoutTrigger');
    const logoutModal = document.getElementById('logoutModal');
    
    // Only setup if elements exist
    if (logoutTrigger && logoutModal) {
        // Create Bootstrap modal instance
        const bsModal = new bootstrap.Modal(logoutModal);
        
        // Add click event to logout trigger
        logoutTrigger.addEventListener('click', function(e) {
            e.preventDefault(); // Prevent default link behavior
            bsModal.show(); // Show the modal
        });
        
        // Optional: Add event to "Yes, Logout" button for any additional handling
        const confirmLogoutBtn = logoutModal.querySelector('.btn-danger');
        if (confirmLogoutBtn) {
            confirmLogoutBtn.addEventListener('click', function() {
                // The button already has href="{% url 'logout' %}" so it will redirect automatically
                // You can add loading spinner or other UX here if needed
                console.log('Logging out...');
            });
        }
    } else {
        console.error('Logout elements not found:', {
            trigger: !!logoutTrigger,
            modal: !!logoutModal
        });
    }
});
    // Delivery assignment functionality
    
document.addEventListener('DOMContentLoaded', function() {
    // ===== DELIVERY ASSIGNMENT FUNCTIONALITY =====
    const deliveriesTable = document.getElementById('deliveries-table');
    const bulkAssignmentSection = document.getElementById('bulk-assignment-section');
    const bulkAssignBtn = document.getElementById('bulk-assign-btn');
    const selectAllCheckbox = document.getElementById('select-all-deliveries');

    // Individual delivery person assignment
    if (deliveriesTable) {
        deliveriesTable.addEventListener('change', function(e) {
            if (e.target.classList.contains('delivery-person-select')) {
                const select = e.target;
                const row = select.closest('tr');
                if (!row) return;
                
                const deliveryId = row.dataset.deliveryId;
                const deliveryPersonId = select.value;
                const deliveryDateInput = row.querySelector('.delivery-date');
                const deliveryDate = deliveryDateInput ? deliveryDateInput.value : '';

                if (deliveryPersonId) {
                    assignDeliveryPerson(deliveryId, deliveryPersonId, deliveryDate, select);
                } else {
                    // If no delivery person selected, show warning
                    select.classList.add('is-invalid');
                    setTimeout(() => select.classList.remove('is-invalid'), 3000);
                }
            }
        });
    }

    // Individual delivery date change
    if (deliveriesTable) {
        deliveriesTable.addEventListener('change', function(e) {
            if (e.target.classList.contains('delivery-date')) {
                const dateInput = e.target;
                const row = dateInput.closest('tr');
                if (!row) return;
                
                const deliveryId = row.dataset.deliveryId;
                const deliveryPersonSelect = row.querySelector('.delivery-person-select');
                const deliveryPersonId = deliveryPersonSelect ? deliveryPersonSelect.value : '';

                if (deliveryPersonId) {
                    assignDeliveryPerson(deliveryId, deliveryPersonId, dateInput.value, dateInput);
                } else {
                    // Show warning if no delivery person is assigned
                    showError('Please assign a delivery person first');
                    dateInput.classList.add('is-invalid');
                    setTimeout(() => dateInput.classList.remove('is-invalid'), 3000);
                }
            }
        });
    }

    // Delete delivery functionality
    if (deliveriesTable) {
        deliveriesTable.addEventListener('click', function(e) {
            if (e.target.classList.contains('delete-delivery-btn') || 
                e.target.closest('.delete-delivery-btn')) {
                const button = e.target.classList.contains('delete-delivery-btn') ? 
                    e.target : e.target.closest('.delete-delivery-btn');
                const deliveryId = button.dataset.deliveryId;
                
                if (confirm('Are you sure you want to delete this delivery? This action cannot be undone.')) {
                    deleteDelivery(deliveryId, button);
                }
            }
        });
    }

    // ===== BULK ASSIGNMENT FUNCTIONALITY =====
    
    // Select all deliveries
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            const checkboxes = deliveriesTable.querySelectorAll('.delivery-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            toggleBulkAssignmentSection();
        });
    }

    // Individual checkbox change
    if (deliveriesTable) {
        deliveriesTable.addEventListener('change', function(e) {
            if (e.target.classList.contains('delivery-checkbox')) {
                toggleBulkAssignmentSection();
            }
        });
    }

    // Toggle bulk assignment section
    function toggleBulkAssignmentSection() {
        if (!bulkAssignmentSection) return;
        const checkedBoxes = deliveriesTable ? deliveriesTable.querySelectorAll('.delivery-checkbox:checked') : [];
        bulkAssignmentSection.style.display = checkedBoxes.length > 0 ? 'block' : 'none';
        
        // Update select all checkbox state
        if (selectAllCheckbox) {
            const allCheckboxes = deliveriesTable.querySelectorAll('.delivery-checkbox');
            const allChecked = allCheckboxes.length > 0 && checkedBoxes.length === allCheckboxes.length;
            selectAllCheckbox.checked = allChecked;
            selectAllCheckbox.indeterminate = checkedBoxes.length > 0 && !allChecked;
        }
    }

    // Bulk assignment
    if (bulkAssignBtn) {
        bulkAssignBtn.addEventListener('click', function() {
            const deliveryPersonId = document.getElementById('bulk-delivery-person')?.value;
            const deliveryDate = document.getElementById('bulk-delivery-date')?.value;
            const checkedBoxes = deliveriesTable ? deliveriesTable.querySelectorAll('.delivery-checkbox:checked') : [];

            if (!deliveryPersonId) {
                showError('Please select a delivery person for bulk assignment');
                return;
            }

            if (checkedBoxes.length === 0) {
                showError('Please select at least one delivery');
                return;
            }

            if (confirm(`Assign ${checkedBoxes.length} delivery(s) to selected delivery person?`)) {
                const assignments = [];
                let completed = 0;
                let failed = 0;
                
                // Show loading state
                bulkAssignBtn.disabled = true;
                bulkAssignBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Assigning...';
                
                checkedBoxes.forEach(checkbox => {
                    const deliveryId = checkbox.value;
                    assignments.push(
                        assignDeliveryPerson(deliveryId, deliveryPersonId, deliveryDate)
                            .then(success => {
                                if (success) completed++;
                                else failed++;
                            })
                    );
                });

                Promise.all(assignments).then(() => {
                    // Reset button state
                    bulkAssignBtn.disabled = false;
                    bulkAssignBtn.innerHTML = 'Assign Selected';
                    
                    if (failed === 0) {
                        showSuccess(`Successfully assigned all ${completed} deliveries!`);
                        // Reload page to reflect changes
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        showError(`Assigned ${completed} deliveries, but ${failed} failed. Please check the console for details.`);
                    }
                }).catch(error => {
                    console.error('Error in bulk assignment:', error);
                    bulkAssignBtn.disabled = false;
                    bulkAssignBtn.innerHTML = 'Assign Selected';
                    showError('Some assignments failed. Please check the console for details.');
                });
            }
        });
    }

    // ===== CORE FUNCTIONS =====
    
    // Function to assign delivery person
    function assignDeliveryPerson(deliveryId, deliveryPersonId, deliveryDate, element = null) {
        console.log('Assigning delivery:', { deliveryId, deliveryPersonId, deliveryDate });
        
        return fetch('{% url "assign_delivery_person" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                delivery_id: deliveryId,
                delivery_person_id: deliveryPersonId,
                delivery_date: deliveryDate
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                showSuccess(data.message);
                if (element) {
                    // Visual feedback
                    element.classList.remove('is-invalid');
                    element.classList.add('is-valid');
                    setTimeout(() => element.classList.remove('is-valid'), 2000);
                }
                return true;
            } else {
                throw new Error(data.error || 'Unknown error occurred');
            }
        })
        .catch(error => {
            console.error('Error assigning delivery:', error);
            showError(error.message);
            if (element) {
                // Visual feedback for error
                element.classList.remove('is-valid');
                element.classList.add('is-invalid');
                setTimeout(() => element.classList.remove('is-invalid'), 3000);
            }
            return false;
        });
    }

    // Function to delete delivery

    // ===== UTILITY FUNCTIONS =====
    
    // Utility function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Success message handler
    function showSuccess(message) {
        const successModal = document.getElementById('successModal');
        if (successModal) {
            document.getElementById('successMessage').textContent = message;
            const modal = new bootstrap.Modal(successModal);
            modal.show();
        } else {
            // Fallback to toast or alert
            createToast('success', message);
        }
    }

    // Error message handler
    function showError(message) {
        // Create a temporary toast notification
        createToast('error', message);
    }

    // Create toast notifications
    function createToast(type, message) {
        const toastContainer = document.getElementById('toast-container') || createToastContainer();
        const toastId = 'toast-' + Date.now();
        
        const bgColor = type === 'success' ? 'bg-success' : 'bg-danger';
        const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
        
        const toastHTML = `
            <div id="${toastId}" class="toast align-items-center text-white ${bgColor} border-0" role="alert">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas ${icon} me-2"></i>${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        `;
        
        toastContainer.insertAdjacentHTML('beforeend', toastHTML);
        const toastElement = document.getElementById(toastId);
        const toast = new bootstrap.Toast(toastElement, { delay: 5000 });
        toast.show();
        
        // Remove toast from DOM after hide
        toastElement.addEventListener('hidden.bs.toast', function () {
            this.remove();
        });
    }

    // Create toast container if it doesn't exist
    function createToastContainer() {
        const container = document.createElement('div');
        container.id = 'toast-container';
        container.className = 'toast-container position-fixed top-0 end-0 p-3';
        container.style.zIndex = '9999';
        document.body.appendChild(container);
        return container;
    }

    console.log('Delivery management JavaScript loaded successfully');
});
// Plans & Pricing functionality
document.addEventListener('DOMContentLoaded', function() {
    // Filter active publications
    const filterActiveBtn = document.getElementById('filter-active');
    if (filterActiveBtn) {
        let showActiveOnly = false;
        filterActiveBtn.addEventListener('click', function() {
            showActiveOnly = !showActiveOnly;
            const rows = document.querySelectorAll('#publications-table tbody tr');
            
            rows.forEach(row => {
                if (showActiveOnly) {
                    const isAvailable = !row.classList.contains('table-secondary');
                    row.style.display = isAvailable ? '' : 'none';
                } else {
                    row.style.display = '';
                }
            });
            
            filterActiveBtn.innerHTML = showActiveOnly ? 
                '<i class="fas fa-times"></i> Show All' : 
                '<i class="fas fa-filter"></i> Active Only';
            filterActiveBtn.classList.toggle('btn-primary', showActiveOnly);
            filterActiveBtn.classList.toggle('btn-outline-primary', !showActiveOnly);
        });
    }

    // Add publication form handling
    const addPublicationForm = document.getElementById('addPublicationForm');
    if (addPublicationForm) {
        addPublicationForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);
            
            // Add loading state
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';
            submitBtn.disabled = true;
            
            // Simulate API call - you'll need to implement the actual backend endpoint
            setTimeout(() => {
                // For now, just show success and reload
                showSuccess('Publication added successfully!');
                setTimeout(() => {
                    location.reload();
                }, 1500);
            }, 1000);
        });
    }

    // Toggle publication availability
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('toggle-publication-btn') || 
            e.target.closest('.toggle-publication-btn')) {
            const button = e.target.classList.contains('toggle-publication-btn') ? 
                e.target : e.target.closest('.toggle-publication-btn');
            const publicationId = button.dataset.publicationId;
            const isCurrentlyAvailable = button.querySelector('.fa-pause') !== null;
            
            const action = isCurrentlyAvailable ? 'deactivate' : 'activate';
            const confirmationMessage = `Are you sure you want to ${action} this publication?`;
            
            if (confirm(confirmationMessage)) {
                togglePublicationAvailability(publicationId, button, !isCurrentlyAvailable);
            }
        }
    });

    // Delete publication
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('delete-publication-btn') || 
            e.target.closest('.delete-publication-btn')) {
            const button = e.target.classList.contains('delete-publication-btn') ? 
                e.target : e.target.closest('.delete-publication-btn');
            const publicationId = button.dataset.publicationId;
            
            if (confirm('Are you sure you want to delete this publication? This action cannot be undone.')) {
                deletePublication(publicationId, button);
            }
        }
    });

    // Edit publication
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('edit-publication-btn') || 
            e.target.closest('.edit-publication-btn')) {
            const button = e.target.classList.contains('edit-publication-btn') ? 
                e.target : e.target.closest('.edit-publication-btn');
            const publicationId = button.dataset.publicationId;
            
            // For now, just show a message - you can implement edit modal later
            showInfo('Edit functionality will be implemented in the next phase.');
        }
    });

    // Function to toggle publication availability
    function togglePublicationAvailability(publicationId, button, newStatus) {
        // Show loading state
        const originalHTML = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        button.disabled = true;
        
        // Simulate API call - implement actual backend endpoint
        fetch(`/api/publications/${publicationId}/toggle-availability/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ is_available: newStatus })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccess(data.message);
                // Reload to reflect changes
                setTimeout(() => location.reload(), 1000);
            } else {
                throw new Error(data.error);
            }
        })
        .catch(error => {
            console.error('Error toggling publication:', error);
            showError('Failed to update publication status');
            // Reset button state
            button.innerHTML = originalHTML;
            button.disabled = false;
        });
    }

    // Function to delete publication
    function deletePublication(publicationId, button) {
        // Show loading state
        const originalHTML = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        button.disabled = true;
        
        // Simulate API call - implement actual backend endpoint
        fetch(`/api/publications/${publicationId}/delete/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccess(data.message);
                // Remove row with animation
                const row = button.closest('tr');
                row.style.opacity = '0';
                row.style.transition = 'opacity 0.3s ease';
                setTimeout(() => row.remove(), 300);
            } else {
                throw new Error(data.error);
            }
        })
        .catch(error => {
            console.error('Error deleting publication:', error);
            showError('Failed to delete publication');
            // Reset button state
            button.innerHTML = originalHTML;
            button.disabled = false;
        });
    }

    // Helper function for info messages
    function showInfo(message) {
        createToast('info', message, 'bg-info');
    }
});

// Add this to your existing createToast function
function createToast(type, message, customBg = '') {
    const toastContainer = document.getElementById('toast-container') || createToastContainer();
    const toastId = 'toast-' + Date.now();
    
    let bgColor = customBg;
    if (!bgColor) {
        bgColor = type === 'success' ? 'bg-success' : 
                  type === 'error' ? 'bg-danger' : 
                  type === 'info' ? 'bg-info' : 'bg-primary';
    }
    
    const icon = type === 'success' ? 'fa-check-circle' : 
                 type === 'error' ? 'fa-exclamation-circle' : 
                 type === 'info' ? 'fa-info-circle' : 'fa-bell';
    
    const toastHTML = `
        <div id="${toastId}" class="toast align-items-center text-white ${bgColor} border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas ${icon} me-2"></i>${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;
    
    toastContainer.insertAdjacentHTML('beforeend', toastHTML);
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement, { delay: 5000 });
    toast.show();
    
    toastElement.addEventListener('hidden.bs.toast', function () {
        this.remove();
    });
}
// Simple Commission Functions
    // Enhanced Commission Functions with Debugging
// Add test button to commissions section
document.addEventListener('DOMContentLoaded', function() {
    const commissionsSection = document.getElementById('commissions');
    if (commissionsSection) {
        const testButton = document.createElement('button');
        testButton.type = 'button';
        testButton.className = 'btn btn-warning btn-sm ms-2';
        testButton.innerHTML = '<i class="fas fa-bug"></i> Test API';
        testButton.onclick = testCommissionEndpoints;
        
        const commissionHeader = commissionsSection.querySelector('.card-header');
        if (commissionHeader) {
            commissionHeader.appendChild(testButton);
        }
    }
});
function approveCommission(commissionId) {
    if (confirm('Approve this commission?')) {
        updateCommissionStatus(commissionId, 'approved');
    }
}

function rejectCommission(commissionId) {
    if (confirm('Reject this commission?')) {
        updateCommissionStatus(commissionId, 'rejected');
    }
}

function markAsPaid(commissionId) {
    if (confirm('Mark this commission as paid?')) {
        updateCommissionStatus(commissionId, 'paid');
    }
}

function updateCommissionStatus(commissionId, status) {
    fetch(`/api/commissions/${commissionId}/update-status/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ status: status })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess(`Commission ${status} successfully`);
            location.reload();
        } else {
            throw new Error(data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showError(`Failed to ${status} commission`);
    });
}
// Reports functionality
document.addEventListener('DOMContentLoaded', function() {
    // Report type switching
    const reportButtons = document.querySelectorAll('[data-report-type]');
    const reportContents = document.querySelectorAll('.report-content');
    
    reportButtons.forEach(button => {
        button.addEventListener('click', function() {
            const reportType = this.dataset.reportType;
            
            // Update active button
            reportButtons.forEach(btn => {
                btn.classList.remove('active');
                btn.classList.add('btn-outline-primary');
            });
            this.classList.add('active');
            this.classList.remove('btn-outline-primary');
            
            // Show corresponding report content
            reportContents.forEach(content => {
                content.style.display = 'none';
            });
            document.getElementById(`${reportType}-report`).style.display = 'block';
        });
    });
});

// Download report function
// Fixed Download Report PDF Function
function downloadReport(reportType) {
    console.log('Starting PDF download for:', reportType);
    
    // Show loading state
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
    btn.disabled = true;
    
    // Validate report type
    const validReports = ['payment', 'commission', 'subscription'];
    if (!validReports.includes(reportType)) {
        showError('Invalid report type: ' + reportType);
        btn.innerHTML = originalText;
        btn.disabled = false;
        return;
    }
    
    // Create the download URL - using the correct URL pattern
    const downloadUrl = `/manager/reports/download/${reportType}/`;
    console.log('Download URL:', downloadUrl);
    
    // Method 1: Direct window location (most reliable)
    try {
        // Create a temporary anchor element to trigger download
        const anchor = document.createElement('a');
        anchor.href = downloadUrl;
        anchor.target = '_blank';
        anchor.style.display = 'none';
        document.body.appendChild(anchor);
        anchor.click();
        document.body.removeChild(anchor);
        
        showSuccess(`Generating ${reportType} report PDF...`);
        
        // Reset button after a delay
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }, 3000);
        
    } catch (error) {
        console.error('Download error:', error);
        
        // Method 2: Fallback - open in new tab
        window.open(downloadUrl, '_blank');
        
        showSuccess(`Opening ${reportType} report in new tab...`);
        
        // Reset button
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

// You can also add these simple filter functions if custom filters don't work
function sumArray(arr, key) {
    return arr.reduce((sum, item) => sum + (item[key] || 0), 0);
}
// Notifications functionality
document.addEventListener('DOMContentLoaded', function() {
    const notificationForm = document.getElementById('sendNotificationForm');
    const targetAudience = document.getElementById('targetAudience');
    const specificCustomersSection = document.getElementById('specificCustomersSection');
    const notificationType = document.getElementById('notificationType');
    const recipientCount = document.getElementById('recipientCountNumber');
    
    // Update recipient count based on target audience
    if (targetAudience) {
        targetAudience.addEventListener('change', updateRecipientCount);
        updateRecipientCount(); // Initial calculation
    }
    
    // Show/hide specific customers selection
    if (targetAudience && specificCustomersSection) {
        targetAudience.addEventListener('change', function() {
            if (this.value === 'specific_customers') {
                specificCustomersSection.style.display = 'block';
            } else {
                specificCustomersSection.style.display = 'none';
            }
            updateRecipientCount();
        });
    }
    
    // Auto-fill subject based on type
    if (notificationType) {
        notificationType.addEventListener('change', function() {
            const subjectField = document.getElementById('notificationSubject');
            const messageField = document.getElementById('notificationMessage');
            
            if (this.value && !subjectField.value) {
                const typeTitles = {
                    'payment_reminder': 'Payment Reminder',
                    'renewal': 'Subscription Renewal Notice',
                    'status_update': 'Account Status Update',
                    'delivery_update': 'Delivery Schedule Update',
                    'general': 'Important Announcement'
                };
                subjectField.value = typeTitles[this.value] || '';
            }
        });
    }
    
    // Form submission
    if (notificationForm) {
        notificationForm.addEventListener('submit', function(e) {
            e.preventDefault();
            sendNotification();
        });
    }
    
    // Update recipient count
    function updateRecipientCount() {
        if (!targetAudience || !recipientCount) return;
        
        const audienceCounts = {
            'all_customers': {{ customers.count }},
            'overdue_payments': {{ customers_with_overdue.count }},
            'expiring_subscriptions': {{ customers_expiring_soon.count }},
            'specific_customers': 0
        };
        
        let count = audienceCounts[targetAudience.value] || 0;
        
        if (targetAudience.value === 'specific_customers') {
            const selectedCustomers = document.getElementById('specificCustomers');
            count = selectedCustomers ? selectedCustomers.selectedOptions.length : 0;
        }
        
        recipientCount.textContent = count;
        
        // Show warning if no recipients
        const recipientAlert = document.getElementById('recipientCount');
        if (count === 0) {
            recipientAlert.classList.remove('alert-info');
            recipientAlert.classList.add('alert-warning');
        } else {
            recipientAlert.classList.remove('alert-warning');
            recipientAlert.classList.add('alert-info');
        }
    }
    
    // Update count when specific customers change
    const specificCustomers = document.getElementById('specificCustomers');
    if (specificCustomers) {
        specificCustomers.addEventListener('change', updateRecipientCount);
    }
});

// Load template function
function loadTemplate(templateType) {
    const messageField = document.getElementById('notificationMessage');
    const typeField = document.getElementById('notificationType');
    const subjectField = document.getElementById('notificationSubject');
    
    const templates = {
        'payment_reminder': {
            subject: 'Payment Reminder - Action Required',
            message: 'Dear customer,\n\nThis is a friendly reminder that your payment is overdue. Please clear your outstanding balance at your earliest convenience to avoid any interruption in service.\n\nThank you for your prompt attention to this matter.\n\nBest regards,\nNewsExpress Team'
        },
        'renewal': {
            subject: 'Subscription Renewal Notice',
            message: 'Dear customer,\n\nYour subscription is due for renewal soon. To continue enjoying uninterrupted service, please renew your subscription before the expiration date.\n\nYou can renew your subscription through your dashboard or contact our support team for assistance.\n\nThank you for being a valued customer!\n\nBest regards,\nNewsExpress Team'
        },
        'delivery_update': {
            subject: 'Delivery Schedule Update',
            message: 'Dear customer,\n\nWe wanted to inform you about an update to our delivery schedule. Please check your account for the latest delivery timings and any changes that might affect your service.\n\nIf you have any questions, feel free to contact our support team.\n\nThank you for your understanding.\n\nBest regards,\nNewsExpress Team'
        },
        'general': {
            subject: 'Important Announcement',
            message: 'Dear valued customer,\n\nWe have an important announcement regarding our services. Please visit our website or check your account for more details.\n\nThank you for your continued support.\n\nBest regards,\nNewsExpress Team'
        }
    };
    
    if (templates[templateType]) {
        if (typeField) typeField.value = templateType;
        if (subjectField) subjectField.value = templates[templateType].subject;
        if (messageField) messageField.value = templates[templateType].message;
    }
    
    // Update recipient count
    updateRecipientCount();
}

    // Send notification function
    function sendNotification() {
        console.log('Starting notification send process...');
        
        const form = document.getElementById('sendNotificationForm');
        if (!form) {
            console.error('Notification form not found!');
            showError('Notification form not found');
            return;
        }
        
        // Show loading state
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
        submitBtn.disabled = true;
        
        try {
            // Get form data
            const formData = new FormData(form);
            
            // Get selected channels
            const channelCheckboxes = form.querySelectorAll('input[name="channels"]:checked');
            const channels = Array.from(channelCheckboxes).map(cb => cb.value);
            
            // Get specific customers if selected
            let specificCustomers = [];
            if (formData.get('target_audience') === 'specific_customers') {
                const specificCustomersSelect = document.getElementById('specificCustomers');
                if (specificCustomersSelect) {
                    specificCustomers = Array.from(specificCustomersSelect.selectedOptions).map(opt => opt.value);
                }
            }
            
            // Prepare data for API
            const data = {
                'notification_type': formData.get('notification_type'),
                'target_audience': formData.get('target_audience'),
                'subject': formData.get('subject'),
                'message': formData.get('message'),
                'channels': channels,
                'specific_customers': specificCustomers
            };
            
            console.log('Sending notification data:', data);
            
            // Validate required fields
            if (!data.notification_type || !data.target_audience || !data.subject || !data.message) {
                throw new Error('Please fill in all required fields');
            }
            
            if (data.channels.length === 0) {
                throw new Error('Please select at least one delivery channel');
            }
            
            if (data.target_audience === 'specific_customers' && data.specific_customers.length === 0) {
                throw new Error('Please select at least one customer');
            }
            
            // Send request to backend
            fetch('{% url "send_notification" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(result => {
                console.log('Notification send response:', result);
                
                if (result.success) {
                    showSuccess(`Notifications sent successfully! ${result.successful_count || 0} delivered, ${result.failed_count || 0} failed`);
                    
                    // Reset form
                    form.reset();
                    
                    // Reload page to show new notification in recent list
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                    
                } else {
                    throw new Error(result.error || 'Unknown error from server');
                }
            })
            .catch(error => {
                console.error('Error sending notification:', error);
                showError('Failed to send notification: ' + error.message);
            })
            .finally(() => {
                // Reset button state
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            });
            
        } catch (error) {
            console.error('Error in notification process:', error);
            showError(error.message);
            // Reset button state
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    }

    // Enhanced form submission handler
document.addEventListener('DOMContentLoaded', function() {
    const notificationForm = document.getElementById('sendNotificationForm');
    
    if (notificationForm) {
        console.log('Notification form found, setting up event listener...');
        
        notificationForm.addEventListener('submit', function(e) {
            e.preventDefault();
            console.log('Form submission intercepted');
            sendNotification();
        });
        
        // Add test button to form
        const testButton = document.createElement('button');
        testButton.type = 'button';
        testButton.className = 'btn btn-warning btn-sm mt-2';
        testButton.innerHTML = '<i class="fas fa-bug"></i> Test Notification API';
        testButton.onclick = testNotificationEndpoint;
        
        const formActions = notificationForm.querySelector('.d-grid');
        if (formActions) {
            formActions.appendChild(testButton);
        }
        
    } else {
        console.error('Notification form not found!');
    }
    
    // Update recipient count when audience changes
    const targetAudience = document.getElementById('targetAudience');
    if (targetAudience) {
        targetAudience.addEventListener('change', updateRecipientCount);
    }
});


    // Complete Publication Form Handling with Debugging
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded - setting up publication form');
    
    const addPublicationForm = document.getElementById('addPublicationForm');
    
    if (addPublicationForm) {
        console.log('Publication form found');
        
        addPublicationForm.addEventListener('submit', function(e) {
            e.preventDefault();
            console.log('Form submission intercepted');
            
            // Get all form data
            const formData = new FormData(this);
            const data = {
                'title': formData.get('title'),
                'type': formData.get('type'),
                'monthly_price': formData.get('monthly_price'),
                'frequency': formData.get('frequency'),
                'publisher': formData.get('publisher'),
                //'description': formData.get('description'),
                // 'image_url': formData.get('image_url'),
                'is_available': document.getElementById('is_available').checked
            };
            
            console.log('Form data collected:', data);
            
            // Validate required fields
            const requiredFields = ['title', 'type', 'monthly_price', 'frequency', 'publisher'];
            const missingFields = requiredFields.filter(field => !data[field]);
            
            if (missingFields.length > 0) {
                const errorMsg = 'Missing required fields: ' + missingFields.join(', ');
                console.error('Validation error:', errorMsg);
                showError(errorMsg);
                return;
            }
            
            // Show loading state
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';
            submitBtn.disabled = true;
            
            console.log('Sending request to backend...');
            
            // Send AJAX request
            fetch('{% url "add_publication" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                console.log('Response received, status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(result => {
                console.log('Backend response:', result);
                
                if (result.success) {
                    showSuccess(result.message);
                    console.log('Publication added successfully');
                    
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addPublicationModal'));
                    if (modal) {
                        modal.hide();
                    }
                    
                    // Refresh page after delay to show new publication
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                    
                } else {
                    throw new Error(result.error || 'Unknown error from server');
                }
            })
            .catch(error => {
                console.error('Error in form submission:', error);
                showError('Failed to add publication: ' + error.message);
                
                // Reset button
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            });
        });
        
    } else {
        console.error('Publication form not found!');
    }
    
    // Debug: Add a test button to manually test the endpoint
    const debugButton = document.createElement('button');
    debugButton.type = 'button';
    debugButton.className = 'btn btn-warning btn-sm mt-2';
    debugButton.innerHTML = '<i class="fas fa-bug"></i> Test Publication API';
    debugButton.onclick = testPublicationEndpoint;
    
    const formActions = document.querySelector('#addPublicationForm .modal-footer');
    if (formActions) {
        formActions.appendChild(debugButton);
    }
});

// Enhanced getCookie function
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    
    if (!cookieValue) {
        console.warn('CSRF cookie not found!');
    } else {
        console.log('CSRF token found');
    }
    
    return cookieValue;
}
// Enable submit button only when confirmation is checked
$('#confirm-assignment').on('change', function() {
    $('#submit-btn').prop('disabled', !this.checked);
});

// Form submission handling
$('#delivery-assignment-form').on('submit', function(e) {
    const selectedAssignments = $('.delivery-person-select').filter(function() {
        return $(this).val() !== '';
    }).length;
    
    if (selectedAssignments === 0) {
        e.preventDefault();
        showAlert('Please assign at least one delivery before submitting.', 'warning');
        return;
    }
    
    // Show loading state
    $('#submit-btn').html('<i class="fas fa-spinner fa-spin me-2"></i> Assigning...').prop('disabled', true);
});

// Real-time assignment counter
function updateAssignmentCounter() {
    const selectedCount = $('.delivery-person-select').filter(function() {
        return $(this).val() !== '';
    }).length;
    
    const totalCount = $('.delivery-person-select').length;
    
    if (selectedCount > 0) {
        $('#submit-btn').html(`<i class="fas fa-paper-plane me-2"></i> Assign ${selectedCount} Deliveries`);
    } else {
        $('#submit-btn').html('<i class="fas fa-paper-plane me-2"></i> Submit Assignments');
    }
}

$('.delivery-person-select').on('change', function() {
    updateAssignmentCounter();
});

// Initialize counter on page load
$(document).ready(function() {
    updateAssignmentCounter();
});

function showAlert(message, type) {
    const alertClass = type === 'warning' ? 'alert-warning' : 'alert-danger';
    const $alert = $(`<div class="alert ${alertClass} alert-dismissible fade show" role="alert">
        <i class="fas fa-exclamation-triangle me-2"></i>${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>`);
    
    $('#deliveries .card-body').prepend($alert);
    
    setTimeout(() => {
        $alert.alert('close');
    }, 5000);
}
</script>
{% endblock %}